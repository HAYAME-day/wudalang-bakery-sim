<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>武大郎卖炊饼模拟器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    body { max-width: 420px; margin: 0 auto; font-size: 16px; background: #f6f6f9; transition: background 0.7s;}
    #status { margin: 10px 0 0 0; padding: 6px 0; background: #fffbe7; border-radius: 10px; text-align: center; }
    #news {
      margin: 16px 0 0 0;
      background: #eaf3ff;
      color: #2b4c88;
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 15px;
      font-weight: bold;
      letter-spacing: 1px;
      box-shadow: 0 2px 8px rgba(150,170,210,.08);
      text-align: center;
    }
    #materials {
      margin: 10px 0 0 0; padding: 7px 0 7px 0; background: #e9f9e7;
      border-radius: 10px;
      font-size: 15px;
      text-align: center;
      color: #297a21;
    }
    #main-wrap {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      min-height: 390px;
    }
    #text-area {
      background: #fff;
      margin: 18px 0 0 0;
      border-radius: 16px;
      min-height: 130px;
      max-height: 240px;
      box-shadow: 0 2px 8px rgba(0,0,0,.05);
      padding: 16px;
      font-size: 17px;
      line-height: 1.8;
      text-align: left;
      word-break: break-all;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 6px;
      scroll-behavior: smooth;
    }
    #actions {
      margin: 18px 0 0 0;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #actions button {
      padding: 12px 0;
      font-size: 17px;
      border-radius: 8px;
      background: #fff9f2;
      border: 1px solid #eee1c3;
      box-shadow: 0 1px 2px #f6e3c8;
      cursor: pointer;
      transition: background 0.25s, color 0.25s;
    }
    #actions button:active {
      background: #ffe2b5;
    }
    #log {
      color: #888; font-size: 13px; background: #f0f0f0;
      margin: 18px 0 6px 0;
      padding: 8px;
      height: 72px;
      overflow-y: auto;
      border-radius: 10px;
      opacity: 0.88;
    }
    h2 { margin: 20px 0 8px 0; text-align: center; font-weight: bold; }
    .textline { margin-bottom: 3px;}

    /* 好感侧栏 */
    #sidebar-btn {
      position: fixed;
      top: 44px;
      right: 12px;
      z-index: 1002;
      background: #ffd773;
      color: #654800;
      border: none;
      border-radius: 50%;
      width: 38px; height: 38px;
      font-size: 19px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.11);
      cursor: pointer;
      transition: background 0.18s;
    }
    #sidebar-btn:active { background: #ffb85c; }
    #sidebar {
      position: fixed;
      top: 0; right: -240px;
      width: 220px; height: 100%;
      background: #fffbe7;
      border-left: 2px solid #f0d595;
      box-shadow: -3px 0 12px rgba(0,0,0,0.07);
      z-index: 1001;
      transition: right 0.35s;
      padding: 28px 14px 14px 14px;
      display: flex; flex-direction: column; gap: 12px;
    }
    #sidebar.active { right: 0; }
    .favor-title { font-weight: bold; margin-bottom: 8px; }
    .favor-item { display: flex; justify-content: space-between; padding: 4px 0;}
    .favor-name { color: #694c21;}
    .favor-value { color: #d08a36; font-weight: bold;}
  </style>
</head>
<body>
  <h2>武大郎卖炊饼模拟器</h2>
  <div id="status">
    钱：<span id="money">10</span>两｜
    声望：<span id="reputation">10</span>｜
    时辰：<span id="shichen">清晨</span>
  </div>
  <div id="materials"></div>
  <div id="news">【今日街头新闻】今天的街道很热闹，要开始卖炊饼了！</div>
  <div id="main-wrap">
    <div id="text-area"></div>
    <div id="actions"></div>
  </div>
  <div id="log"><ul id="loglist"></ul></div>
  <button id="sidebar-btn" title="查看好感">❤</button>
  <div id="sidebar">
    <div class="favor-title">角色好感</div>
    <div id="favor-list"></div>
  </div>
  <script>
    // 状态变量
    let money = 10, reputation = 10, day = 1, timeIdx = 0, state = 'business';
    const shichenArr = ["清晨", "上午", "中午", "午后", "夜晚"];

    // 材料库存
    let materials = {
      面粉: 5,
      酥油: 5,
      蔬菜: 2,
      肉: 1
    };

    // 好感角色
    let favors = [
      { name: "金莲", value: 60 },
      { name: "西门庆", value: 10 },
      { name: "小伙计", value: 20 }
    ];

    // 炊饼配方
    let products = [
      { name: "普通炊饼", unlocked: true, price: 3, recipe: { 面粉: 1, 酥油: 1 }, intro: "经典炊饼，百姓最爱", id: "basic" },
      { name: "夹心饼", unlocked: false, price: 6, recipe: { 面粉: 1, 酥油: 1, 蔬菜: 1 }, intro: "特制夹心，口味更佳", id: "stuffed" },
      { name: "肉夹心饼", unlocked: false, price: 8, recipe: { 面粉: 1, 酥油: 1, 肉: 1 }, intro: "新鲜肉馅，鲜香四溢", id: "meat" }
    ];

    // 进货渠道
    const purchaseChannels = [
      {
        id: 'farmer', unlocked: true, label: '相熟农户',
        desc: '便宜获取面粉、酥油、蔬菜，偶尔带肉',
        price: 4,
        result: () => {
          materials['面粉'] += 2;
          materials['酥油'] += 2;
          materials['蔬菜'] += 1;
          if (Math.random() < 0.2) {
            materials['肉'] += 1;
            pushText('农户额外给你一份肉（兔子？）');
          }
        }
      },
      {
        id: 'innkeeper', unlocked: true, label: '酒楼奸商',
        desc: '高价买齐全食材，夜间可能触发折箩事件',
        price: 8,
        result: () => {
          materials['面粉'] += 2;
          materials['酥油'] += 2;
          materials['肉'] += 1;
          // 夜间概率触发折箩
          if (isNight() && Math.random() < 0.2) {
            triggerInnDiscardEvent();
            return false;
          }
          materials['蔬菜'] += 1;
        }
      }
    ];

    // 新闻池
    const newsPool = [
      { txt: "商队带来廉价牛羊肉，原料进货更便宜！", effect: ()=>{ newsEffect.cheapGoods = true; } },
      { txt: "城里流行香饼夹白肉，批发订单概率提升！", effect: ()=>{ newsEffect.bigOrder = true; } },
      { txt: "今日天气炎热，大家胃口差，销量略低。", effect: ()=>{ newsEffect.badWeather = true; } },
      { txt: "西门庆溜达过来说夹心，解锁新炊饼！", effect: ()=>{ unlockProduct('stuffed'); } },
      { txt: "坊间谣传：今日卖炊饼可能遇到贵客！", effect: ()=>{ newsEffect.vipChance = true; } },
      { txt: "听说有江南大厨路过本镇，带来肉夹心饼新配方！", effect: ()=>{ unlockProduct('meat'); } },
      { txt: "一切如常，安稳经商的一天。", effect: ()=>{} }
    ];
    let newsEffect = {};

    // 文本历史
    const maxTextHistory = 20;
    let textHistory = [];
    function pushText(txt) {
      textHistory.push(txt);
      if (textHistory.length > maxTextHistory) textHistory.shift();
      renderTextHistory();
    }
    function renderTextHistory() {
      const ta = document.getElementById('text-area');
      ta.innerHTML = "";
      textHistory.forEach(line=>{
        let div = document.createElement('div');
        div.innerHTML = line
        .replace(/\n/g, "<br>")//换行
        .replace(/\*(.*?)\*/g, "<i>$1</i>"); // 匹配一对*号包裹内容，变斜体，心理活动

        div.className = "textline";
        ta.appendChild(div);
      });
      ta.scrollTop = ta.scrollHeight;
    }

    function log(msg) {
      const ul = document.getElementById('loglist');
      ul.insertAdjacentHTML('afterbegin', `<li>${msg}</li>`);
      if (ul.childElementCount > 10) ul.removeChild(ul.lastChild);
    }
    function update() {
      document.getElementById('money').textContent = money;
      document.getElementById('reputation').textContent = reputation;
      document.getElementById('shichen').textContent = shichenArr[timeIdx];
      renderFavors();
      setThemeByTime();
      renderMaterials();
    }
    // 好感侧栏
    function renderFavors() {
      let html = favors.map(f=>`<div class="favor-item"><span class="favor-name">${f.name}</span><span class="favor-value">${f.value}</span></div>`).join("");
      document.getElementById('favor-list').innerHTML = html;
    }
    // 材料栏
    function renderMaterials() {
      let arr = Object.entries(materials).map(([k,v])=>`${k}:${v}`);
      document.getElementById('materials').textContent = '库存｜' + arr.join('　');
    }
    // 动态配色
    function setThemeByTime() {
      let b = document.body, btns = document.querySelectorAll('#actions button');
      if (timeIdx===0) {
        b.style.background = "#f6f6f9";
        btns.forEach(x=>{x.style.background="#fff9f2";x.style.color="#543b0b";});
      } else if (timeIdx<=2) {
        b.style.background = "#fff7e3";
        btns.forEach(x=>{x.style.background="#ffe3b2";x.style.color="#724b00";});
      } else if (timeIdx===3) {
        b.style.background = "#ffe7b8";
        btns.forEach(x=>{x.style.background="#ffb859";x.style.color="#704400";});
      } else {
        b.style.background = "linear-gradient(180deg,#23334c 80%,#39456a 100%)";
        btns.forEach(x=>{x.style.background="#3a4c74";x.style.color="#f8e0aa";});
      }
    }
    // 工具函数
    function isNight() { return timeIdx >= 3; }
    function unlockProduct(pid) {
      let prod = products.find(p => p.id === pid);
      if (prod && !prod.unlocked) {
        prod.unlocked = true;
        log(`新品解锁：「${prod.name}」`);
        pushText(`你解锁了新品：${prod.name}！`);
      }
    }

    // 主操作按钮
    function showBusiness() {
      state = 'business';
      let options = products.filter(p=>p.unlocked).map(p=>{
        return {
          text: `卖${p.name}（${p.intro}）`,
          action: ()=>sell(p)
        };
      });
      setActions([
        ...options,
        { text: '进货', action: shop },
        { text: '宣传', action: advertise },
        { text: '结束今日', action: endDay }
      ]);
    }
    function setActions(buttons) {
      const actions = document.getElementById('actions');
      actions.innerHTML = '';
      buttons.forEach(btn => {
        let b = document.createElement('button');
        b.textContent = btn.text;
        b.onclick = btn.action;
        actions.appendChild(b);
      });
      setThemeByTime();
    }

    // 炊饼售卖逻辑（材料消耗）
    function sell(product) {
      // 检查材料够不够
      for (let key in product.recipe) {
        if ((materials[key]||0) < product.recipe[key]) {
          pushText("材料不足，无法制作"+product.name);
          log('售卖失败：材料不足');
          return;
        }
      }
      // 扣材料
      for (let key in product.recipe) {
        materials[key] -= product.recipe[key];
      }
      let earn = product.price;
      let text = `你叫卖${product.name}，路人纷纷驻足，你顺利卖出几份。`;
      // 新闻与时辰buff
      if (product.id === "stuffed" && newsEffect.bigOrder && Math.random()<0.5 && timeIdx>=2) {//timeIdx>=2指酒楼一般不会大清早和上午来采购
        earn += 6; log("酒楼大批采购，收益翻倍，+6两，声望+2");
        text='城里酒楼的主食不够了，派伙计来大批采购你的夹心饼，今天赚得满满当当！';
        reputation += 2;
      } else if (newsEffect.badWeather && (timeIdx==1||timeIdx==2)) {
        earn = Math.max(1, Math.floor(earn*0.5)); 
        favors[0].value += 1;//总之金莲很高兴
        log('天气炎热，顾客少，收益打折，但金莲不知为何很高兴，金莲好感+1');
        text='太阳暴晒，路人稀少，来买炊饼的更少啊。你干脆招呼着金莲去把家里的被子拿出来晒晒，晚上睡起来也暄软些。';
      } else if (newsEffect.vipChance && Math.random()<0.2 && timeIdx>=3) {
        earn += 8;
        log('+8两');
        text = '一位贵客赏了你不少银两，还对金莲称赞有加。你看着手上的银子，心想要不要给金莲买点什么？';
        // 记录到主文本区
        pushText(text);
        // 进入送礼选择分支，不直接结束本轮
        setActions([
          { text: "买礼物给金莲", action: () => giveGiftToJinlian() },
          { text: "还是省点钱吧", action: () => { pushText("你决定省点钱，家计要紧，钱自然不能乱花。"); nextTime(); } }
        ]);
        // return，终止后续流程
        return;
      }
      function giveGiftToJinlian() {//给金莲买礼物咯！
      // 随机抽取3个不同礼物
        let gifts = [];
        let pool = [...jinlianGiftPool];
        while (gifts.length < 3 && pool.length > 0) {
          let idx = Math.floor(Math.random() * pool.length);
          gifts.push(pool.splice(idx,1)[0]);
        }
        pushText("你决定回家给金莲带点东西，会买什么好呢？");
        setActions(gifts.map(gift=>({
          text: `${gift.name}（${gift.cost}两）`,
          action: ()=>giveGiftResult(gift)
        })));
      }
      const jinlianGiftPool = [//给金莲的礼物池，从中随机抽选
        {
          name: "木头兔子", cost: 3,
          reactions: [
            { prob: 0.6, favor: 1, text: "木匠雕刻的兔子栩栩如生，摸起来也润泽光滑……金莲直拉着你的手抚摸到他自己脸上去，得意地问你有没有本事找到个像他一样摸起来好的。",log:"金莲喜欢礼物，好感度+1" },
            { prob: 0.4, favor: 2, text: "木匠可能是赶着收工，这个小兔子便雕得不大好，边边角角仍带了些棱角没磨平实。你提醒金莲别拿的时候扎到手，金莲甜甜笑，说着：“官人倒是个会疼人的…有这份心意，奴家就很满足了。”" ,log:"金莲喜欢礼物，好感度+2"}
          ]
        },
        {
          name: "雕花发簪", cost: 5,
          reactions: [
            { prob: 0.7, favor: 4, text: "雕花师傅超常发挥，金莲说这簪子比自己带来的嫁妆还要精致许多，捏着上面金灿灿的小花爱不释手。明明只是鎏金而已……",log:"金莲喜欢礼物，好感度+4" },
            { prob: 0.3, favor: 0, tsundere:true, text: "雕花师傅正常发挥，簪子上的花也算得上是精致。但你拿回家给金莲，金莲却横了你一眼：“官人今天晚了半个时辰才回家，可叫奴家好等。就为了这一根和奴家的嫁妆没多大区别的小玩意儿吗？官人便把它丢到奴家妆奁的最底下去就是了。”似乎因为你的晚归，金莲不大高兴，晚上非要像八爪鱼一样缠着你睡。",log:"金莲使小性子，好感度+0" }
          ]
        },
        {
          name: "香囊", cost: 2,
          reactions: [
            { prob: 0.5, favor: 1, text: "金莲觉得味道很宜人，好感+1。" },
            { prob: 0.5, favor: 0, text: "金莲捏捏鼻子，说这味道有点怪……" }
          ]
        }
  // ...可加更多
      ];

      let jinlianTsundereCount = 0; // 金莲使小性子累计次数

      function giveGiftResult(gift) {//给金莲礼物的结果，金莲有概率使小性子，感觉其实也可以使小性子后给加个隐藏数值，然后到达三次以后反而给整个大的！
        if (money<gift.cost) {//没有钱
          pushText("囊中羞涩……");
          log("余额不足，没能给金莲买礼物。");
          nextTime();
          return;
        }
        money-=gift.cost;
        //随机出金莲对礼物的反应
        let roll = Math.random(), acc = 0, selected = gift.reactions[0];
        for (let r of gift.reactions) {
          acc += r.prob;
          if (roll < acc) { selected = r; break; }
        }
        favors[0].value += selected.favor;
        log(selected.log); // 直接输出reaction里写好的log内容
        pushText(`你送给金莲一份${gift.name}。${selected.text}`);
        //判定金莲使小性子次数是否满3次
        if (selected.tsundere) {
          jinlianTsundereCount++;
          if (jinlianTsundereCount >= 3) {
      // 清零并触发特殊事件
            jinlianTsundereCount = 0;
            setTimeout(()=>{
              log("金莲使小性子累计3次，触发隐藏事件，好感度+6");
              pushText("你在家里帮金莲把晾晒好的衣服叠起来的时候，金莲忽然在你转身时悄悄拉了下你的袖子，小声道：“比起礼物，奴家更爱重官人能记住奴家喜欢什么的这份心意。”趁着你感动的时候金莲一下子就凑了上来讨吻。这吻和他平日里那端庄个性完全不一样，恨不得像个章鱼成精一样嗦溜你。\n你摸着自己红肿的嘴唇的时候，金莲才满意地对着梳妆台装模作样整理衣服：“奴家的胭脂都被官人吃掉了……”*也不知道究竟是谁在被吃！*");
        favors[0].value += 6; // 或任意你想要的好感加成
        update();
      }, 400); // 延时让特殊事件出现在主剧情之后
          }
        }
        update();
        nextTime();
      }



      money += earn;
      reputation += 1;
      pushText(text);
      update();
      nextTime();
    }

    // 进货系统
    function shop() {
      setActions(
        purchaseChannels.filter(ch=>ch.unlocked).map(ch=>({
          text: ch.label+"（"+ch.desc+"）",
          action: ()=>purchase(ch)
        })).concat([{text:'返回', action: showBusiness}])
      );
      pushText('请选择进货渠道：');
    }
    function purchase(channel) {
      if (money < channel.price) {
        pushText("钱不够了，无法采购。");
        log('进货失败：余额不足');
        showBusiness();
        return;
      }
      money -= channel.price;
      let branch = channel.result();
      update();
      if (branch === false) return; // 特殊分支事件已处理
      pushText('进货完成！当前库存：'+Object.entries(materials).map(([k,v])=>`${k}:${v}`).join(' | '));
      log('进货成功。');
      showBusiness();
    }

    // 夜间折箩事件
    function triggerInnDiscardEvent() {
      pushText("奸商搓了搓手，暗示今晚酒楼有折箩，要不要顺便捎点？");
      setActions([
        { text:"顺便买折箩", action: ()=>buyInnDiscard() },
        { text:"只买材料", action: ()=>{materials['蔬菜']+=1; showBusiness();} },
        { text:"不买了", action: showBusiness }
      ]);
    }
    function buyInnDiscard() {
      materials['肉'] += 2; materials['蔬菜'] += 2;
      pushText("你买了折箩，大量食材到手，但第二天有顾客腹泻的风险。");
      window.hasInnDiscard = true;
      showBusiness();
    }

    // 宣传
    function advertise() {
      let boost = Math.floor(Math.random()*3)+1;
      reputation += boost;
      pushText(`你热情吆喝，吸引了一批新顾客，声望增加${boost}点！`);
      log("今日大力宣传，声望提升。");
      update();
      nextTime();
    }

    // 时辰推进与夜晚重置
    function nextTime() {
      timeIdx++;
      if(timeIdx>=shichenArr.length){
        setTimeout(endDay,350);
      } else {
        showBusiness();
      }
      update();
      triggerRandomEvent();
    }
    function endDay() {
      day++;
      timeIdx=0;
      newsEffect = {};
      // 新新闻
      let news = newsPool[Math.floor(Math.random() * newsPool.length)];
      news.effect();
      document.getElementById('news').textContent = "【今日街头新闻】" + news.txt;
      pushText(`第${day}天清晨，你又要开始新一天的生意了。`);
      log('新的一天开始了。');
      // 腹泻负面事件判定
      if (window.hasInnDiscard) {
        if (Math.random()<0.5) {
          pushText("次日清晨，有顾客腹泻，店铺声望下降！");
          reputation -= 3;
          log("腹泻事件：声望-3");
        }
        window.hasInnDiscard = false;
      }
      update();
      showBusiness();
    }

    // 时段事件池
    const timeEventPool = [
      {
        name: "早市熟客",
        time: ["清晨"],
        chance: 0.25,
        action: ()=>{
          pushText("早市熟客赶来买饼，还顺带给你送了点小菜。");
          money += 2; reputation += 1;
          log("早市熟客来访，赚2两，声望+1。");
          update();
        }
      },
      {
        name: "中午食客潮",
        time: ["中午"],
        chance: 0.35,
        action: ()=>{
          pushText("午饭时间食客云集，你的炊饼几乎卖脱销！");
          money += 5; reputation += 2;
          log("中午高峰，赚5两，声望+2。");
          update();
        }
      },
      {
        name: "午后偷懒",
        time: ["午后"],
        chance: 0.15,
        action: ()=>{
          pushText("你忍不住偷了个懒，营业暂停了一会儿。");
          log("午后偷懒，进度无收益。");
          update();
        }
      },
      {
        name: "夜晚收摊",
        time: ["夜晚"],
        chance: 0.5,
        action: ()=>{
          pushText("天色已晚，你收拾摊子，准备回家休息。");
          log("夜晚收摊。");
          update();
        }
      }
    ];
    function triggerRandomEvent() {
      const nowTime = shichenArr[timeIdx] || "";
      timeEventPool.forEach(ev=>{
        if (ev.time.includes(nowTime) && Math.random() < ev.chance) {
          ev.action();
        }
      });
    }

    // 好感侧栏交互
    const sidebar = document.getElementById('sidebar');
    document.getElementById('sidebar-btn').onclick = function() {
      sidebar.classList.toggle('active');
    }
    sidebar.onclick = function(e) {
      if (e.target === sidebar) sidebar.classList.remove('active');
    }

    // 初始化
    document.getElementById('news').textContent = "【今日街头新闻】今天的街道很热闹，要开始卖炊饼了！";
    pushText('你整装待发，准备开启一天的生意。');
    update();
    showBusiness();
  </script>
</body>
</html>
